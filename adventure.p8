pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
--adventure game

function _init()
	map_setup()
	text_setup()
	make_player()
	
	game_wim=false
	game_over=false
end

function _update()
	if (not game_over) then
		if (not active_text) then
			update_map()
			move_player()
			check_win_lose()
		end
	else
		if (btnp(‚ùé)) extcmd("reset")
	end
end

function _draw()
	cls()
	if (not game_over) then
		draw_map()
		draw_player()
		draw_text()
		if (btn(‚ùé)) show_inventory()
	else
		draw_win_lose()
	end
end

-->8
--map code

function map_setup()
	--timers
	timer=0
	anim_time=30 --30 = 1 second
	
	--map tile settings
	wall=0
	key=1
	door=2
	anim1=3
	anim2=4
	text=5
	lose=6
	win=7
end

function update_map()
	if (timer<0) then
		toggle_tiles()
		timer=anim_time
	end
	timer-=1
end

function draw_map()
	mapx=flr(p.x/16)*16
	mapy=flr(p.y/16)*16
	camera(mapx*8,mapy*8)
	
	map(0,0,0,0,128,64)
end

function is_tile(tile_type,x,y)
	tile=mget(x,y)
	has_flag=fget(tile,tile_type)
	return has_flag
end

function can_move(x,y)
	return not is_tile(wall,x,y)
end

function swap_tile(x,y)
	tile=mget(x,y)
	mset(x,y,tile+1)
end

function unswap_tile(x,y)
	tile=mget(x,y)
	mset(x,y,tile-1)
end

function get_key(x,y)
	p.keys+=1
	swap_tile(x,y)
	sfx(1)
end

function open_door(x,y)
	p.keys-=1
	swap_tile(x,y)
	sfx(2)
end

-->8
--player code

function make_player()
	p={}
	p.x=3
	p.y=2
	p.sprite=1
	p.keys=0
end

function draw_player()
	spr(p.sprite,p.x*8,p.y*8)
end

function move_player()
	newx=p.x
	newy=p.y
	
	if (btnp(‚¨ÖÔ∏è)) newx-=1
	if (btnp(‚û°Ô∏è)) newx+=1
	if (btnp(‚¨ÜÔ∏è)) newy-=1
	if (btnp(‚¨áÔ∏è)) newy+=1
	
	interact(newx,newy)
	
	if (can_move(newx,newy)) then
		p.x=mid(0,newx,127)
		p.y=mid(0,newy,63)
	else
		sfx(0)
	end
end

function interact(x,y)
	if (is_tile(text,x,y)) then
		active_text=get_text(x,y)
	end
	
	if (is_tile(key,x,y)) then
		get_key(x,y)
	elseif (is_tile(door,x,y) and p.keys>0) then
		open_door(x,y)
	end
end

-->8
--inventory code

function show_inventory()
	invx=mapx*8+40
	invy=mapy*8+8
	
	rectfill(invx,invy,invx+48,invy+24,0)
	print("inventory",invx+7,invy+4,7)
	print("keys "..p.keys,invx+12,invy+14,9)
end

-->8
--animation code

function toggle_tiles()
	for x=mapx,mapx+15 do
		for y=mapy,mapy+15 do
			if (is_tile(anim1,x,y)) then
				swap_tile(x,y)
				sfx(3)
			elseif (is_tile(anim2,x,y)) then
				unswap_tile(x,y)
				sfx(3)
			end	
		end
	end
end

-->8
--win/lose code

function check_win_lose()
	if (is_tile(win,p.x,p.y)) then
		game_win=true
		game_over=true
	elseif (is_tile(lose,p.x,p.y)) then
		game_win=false
		game_over=true
	end
end

function draw_win_lose()
	camera()
	if (game_win) then
		print("‚òÖ you win! ‚òÖ",37,64,7)
	else
		print("game over! :(",38,64,7)
	end
	print("press ‚ùé to play again",20,72,5)
end

-->8
--text code

function text_setup()
	texts={}
	add_text(2,3,"danger - spikes ahead!")
	add_text(8,12,"you're almost there!")
	add_text(7,1,"you found a key!")
end

function add_text(x,y,message)
	texts[x+y*128]=message
end

function get_text(x,y)
	return texts[x+y*128]
end

function draw_text()
	if (active_text) then
		textx=mapx*8+4
		texty=mapy*8+48
		
		rectfill(textx,texty,textx+119,texty+31,7)
		print(active_text,textx+4,texty+4,1)
		print("üÖæÔ∏è to close",textx+4,texty+23,6)
	end
	
	if (btnp(üÖæÔ∏è)) active_text=nil
end

__gfx__
00000000000ff0000000000000000000000000000000000000000000666666660000000000000000000000000000000000000000000000000000000000000000
00000000000ff0000000000000000000000000000000000000000000668888660000000000000000000000000000000000000000000000000000000000000000
00700700022222200000000000000000000000000000000000000000686666860000000000000000000000000000000000000000000000000000000000000000
00077000202222020000000000000000000000000000000000000000686886860000000000000000000000000000000000000000000000000000000000000000
00077000f022220f0000000000000000000000000000000000000000686886860000000000000000000000000000000000000000000000000000000000000000
0070070000cccc000000000000000000000000000000000000000000686666860000000000000000000000000000000000000000000000000000000000000000
0000000000c00c000000000000000000000000000000000000000000668888660000000000000000000000000000000000000000000000000000000000000000
0000000000c00c000000000000000000000000000000000000000000666666660000000000000000000000000000000000000000000000000000000000000000
33333333333333333311133300000000333333333333333300000000333333333333333300000000000000000000000000000000000000000000000000000000
33333333333333333155513300000000999333333333333300000000363336333033303300000000000000000000000000000000000000000000000000000000
3333333333333b3315565513000000009a9999993333333300000000060306030503050300000000000000000000000000000000000000000000000000000000
333333333b33bb331555651300000000939aa9a93333333300000000303330333033303300000000000000000000000000000000000000000000000000000000
333333333bb3b333125555510000000099933a3a3333333300000000333333333333333300000000000000000000000000000000000000000000000000000000
3333333333b333331255655100000000aaa333333333333300000000363336333033303300000000000000000000000000000000000000000000000000000000
33333333333333333122551300000000333333333333333300000000060306030503050300000000000000000000000000000000000000000000000000000000
33333333333333330011113300000000333333333333333300000000303330333033303300000000000000000000000000000000000000000000000000000000
111111111111111111111111000000004a4444a44a4aa4a400000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111cc111111555111000000004a4444a41519915100000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111111111115565511000000004a4444a41111111100000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111111111115556511000000004a4444a41111111100000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111255555100000000aaa99aaa1511115100000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111cc1cc11c255655c00000000191991914a4444a400000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111c2255c1000000004a4444a44a4444a400000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111111111111cccc11000000004a4444a44a4444a400000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666566656600000000555555555555555500000000444444440000000000000000000000000000000000000000000000000000000000000000
666666666666666655555555000000005554455555500555000000004ffffff10000000000000000000000000000000000000000000000000000000000000000
666666666656666666656665000000005444444550000005000000004f1ff1f10000000000000000000000000000000000000000000000000000000000000000
666666666666656655555555000000005114444550000005000000004f1f1ff10000000000000000000000000000000000000000000000000000000000000000
666666666666666665666566000000005444444550000005000000004ffffff10000000000000000000000000000000000000000000000000000000000000000
66666666666666665555555500000000544446455000000500000000411111110000000000000000000000000000000000000000000000000000000000000000
66666666666656666665666500000000511444455000000500000000333413330000000000000000000000000000000000000000000000000000000000000000
66666666666666665555555500000000544444455000000500000000333410030000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000080000000000000000000000100220000481000000000000000010101000301000000000000000000000000010005000021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1010101010101010101010101010101010101011101010202020202020212020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1011101010121014101010111010101010121010102020202020222020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101024101110101020202020212020202020202022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1210371010101010101210101010101010202020222020202020212020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101717171717101010101010102020202020202020202020202020201010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2010111710101017101010202020202020212020202020222020202020101011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020101718181817102020202022202020202020212020202020201012101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2220202031313120202020212020202021202020202020201011101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202131313120202220202020202020202020101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2120202031313121202020202020202020201010101110101010101010111010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020222031313120202020202021201010101210101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2021202031313110101010323232323210101010101010101011101012101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020101031313110371032323030073210101010101012101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2010101031313131313134303030303211101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1011101010101010101032323232323210101011101010101012101010101012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101011101010101010101012101010101010101010101011101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000400000d02000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000500002a07000000370703707037070370603705037050370303701000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0006000012050120501e0502e05000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00030000096200f620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
